# Solution project generated by RASC

cmake_minimum_required(VERSION 3.16.4)

set(CMAKE_SYSTEM_NAME Generic)

set(CMAKE_SYSTEM_PROCESSOR arm)

# Use add_library() with the STATIC option to name the source file in the generated project.
# This avoids running the linker and is intended for use with cross-compiling toolchains that
# cannot link without custom flags or linker scripts
set(CMAKE_TRY_COMPILE_TARGET_TYPE STATIC_LIBRARY)

set(CMAKE_CONFIGURATION_TYPES Debug Release RelWithDebInfo MinSizeRel)

if(BUILD_KIT)
	message(NOTICE "Build Kit is defined as ${BUILD_KIT}")
endif()

message(NOTICE "CMAKE_CURRENT_BINARY_DIR is defined as ${CMAKE_CURRENT_BINARY_DIR}")

get_property(isMultiConfig GLOBAL PROPERTY GENERATOR_IS_MULTI_CONFIG)

if(isMultiConfig)
    message(NOTICE "Multi-config generator(${CMAKE_GENERATOR}) is active")
else()
    message("Single-config generator(${CMAKE_GENERATOR}) is active")
	if(DEFINED CMAKE_BUILD_TYPE)
	 	message(NOTICE "CMAKE_BUILD_TYPE is defined as ${CMAKE_BUILD_TYPE}")
	elseif(DEFINED BUILD_TYPE)
		set(CMAKE_BUILD_TYPE ${BUILD_TYPE})
		message(NOTICE "CMAKE_BUILD_TYPE is set to BUILD_TYPE ENV ${CMAKE_BUILD_TYPE}")
	else()
		message(FATAL_ERROR "Please specify the CMAKE_BUILD_TYPE with -DCMAKE_BUILD_TYPE=")
	endif()
    #set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_BUILD_TYPE})
	message(NOTICE "CMAKE_RUNTIME_OUTPUT_DIRECTORY is defined as ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}")
endif()


# Project configuration
project(mcuboot_boot
	VERSION 1.0.0
	LANGUAGES C CXX ASM)

set(CMAKE_CROSSCOMPILING "TRUE")
set(CMAKE_EXPORT_COMPILE_COMMANDS "TRUE")

include(${CMAKE_CURRENT_LIST_DIR}/Config.cmake)

add_custom_target(${PROJECT_NAME}.sbd ALL
    COMMAND echo "Target for solution bundle"
    COMMENT "*** Target for solution bundle  ***"
)

add_custom_command(
    OUTPUT
        solution.xml.stamp ${CMAKE_CURRENT_SOURCE_DIR}/build/${PROJECT_NAME}.sbd
	COMMAND
        echo Calling RASC for generating solution smart bundle: -nosplash --launcher.suppressErrors --gensolutionbundle --devicefamily ra --compiler GCC --toolchainversion ${CMAKE_C_COMPILER_VERSION} ${CMAKE_CURRENT_SOURCE_DIR}/solution.xml
    COMMAND
        ${RASC_EXE_PATH}  -nosplash --launcher.suppressErrors --gensolutionbundle --devicefamily ra --compiler GCC --toolchainversion ${CMAKE_C_COMPILER_VERSION} ${CMAKE_CURRENT_SOURCE_DIR}/solution.xml 2> rasc_cmd_log.txt
    COMMAND
        ${CMAKE_COMMAND} -E touch solution.xml.stamp
    COMMENT
        "RASC generate solution bundle"
    DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/solution.xml
)

add_custom_target(generate_solution_bundle_${PROJECT_NAME} 
    DEPENDS solution.xml.stamp
)

add_dependencies(${PROJECT_NAME}.sbd generate_solution_bundle_${PROJECT_NAME})


cmake_path(GET CMAKE_CURRENT_SOURCE_DIR PARENT_PATH SOLUTION_PARENT_DIR)

# List of projects in the bundle chain 
add_subdirectory("${SOLUTION_PARENT_DIR}/mcuboot_boot_flat" "${SOLUTION_PARENT_DIR}/mcuboot_boot_flat/build/${CMAKE_BUILD_TYPE}")


# Dependencies of project chain
add_dependencies(generate_content_mcuboot_boot_flat mcuboot_boot.sbd)

# Make target for opening the FSP Configuration in Smart Configurator
add_custom_target(open_rasc_${PROJECT_NAME}
    COMMAND ${RASC_COMMAND}
    WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}"
    COMMENT "FSP Smart Configurator"
)
