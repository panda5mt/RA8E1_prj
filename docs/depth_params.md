# 深度推定パラメータメモ（RA8E1_prj）

このドキュメントは、深度推定（p/q生成 → Frankot–Chellappa積分 → 8bit深度出力）に関する主要パラメータを、現状の実装に合わせて記録したものです。

- 実装本体: [src/main_thread3_entry.c](../src/main_thread3_entry.c)
- 反映方法: これらは `#ifndef ... #define ...` 形式のため、(A) ソースを編集するか、(B) ビルド定義（コンパイル時 `-D`）で上書きできます。
- 記録日: 2026-01-09

## 参照リンク（コード上の定義位置）

- FC128 出力チューニング（`FC128_EXPORT_*`）: [src/main_thread3_entry.c#L54-L85](../src/main_thread3_entry.c#L54-L85)
- FC FFTサイズ選択（`FC_FFT_N`, `FC_RESULT_N`）: [src/main_thread3_entry.c#L318-L346](../src/main_thread3_entry.c#L318-L346)
- PQ128 ROI/stride/ゼロ埋め/境界ゼロ（`PQ128_SIZE` 〜 `PQ128_*_OFFSET`）: [src/main_thread3_entry.c#L87-L149](../src/main_thread3_entry.c#L87-L149)
- PQ128 正規化/モード/符号（`PQ128_NORM_*`, `PQ128_PQ_MODE`, `PQ128_FLIP_*`）: [src/main_thread3_entry.c#L150-L199](../src/main_thread3_entry.c#L150-L199)
- 飽和マスク（`PQ128_SAT_*`）: [src/main_thread3_entry.c#L201-L227](../src/main_thread3_entry.c#L201-L227)
- 暗部マスク（`PQ128_USE_DARK_SOFTMASK` ほか）: [src/main_thread3_entry.c#L228-L251](../src/main_thread3_entry.c#L228-L251)
- クロマ境界マスク（`PQ128_USE_CHROMA_EDGEMASK` ほか）: [src/main_thread3_entry.c#L252-L278](../src/main_thread3_entry.c#L252-L278)
- 強度ニー（`PQ128_USE_INTENSITY_KNEE` ほか）: [src/main_thread3_entry.c#L279-L293](../src/main_thread3_entry.c#L279-L293)
- テーパ（`PQ128_USE_TAPER` ほか）: [src/main_thread3_entry.c#L294-L304](../src/main_thread3_entry.c#L294-L304)

---

## 1. 処理の流れ（ざっくり）

1) 320×240 UYVY → Y（輝度）抽出
2) 128×128 ROI（必要なら間引き/ゼロ埋め）で p/q（勾配）生成
3) Frankot–Chellappa（FFT）で深度面を復元（128×128）
4) 320×240 出力バッファに 8bit 正規化して配置（中央に貼る）

---

## 2. ROI（128×128）と取り込み範囲

| マクロ | デフォルト | 意味 | 調整の目安 |
|---|---:|---|---|
| `PQ128_SIZE` | 128 | p/qのサイズ（固定） | 通常は固定 |
| `PQ128_SAMPLE_STRIDE_X` | 2 | X方向のサンプリング間隔 | 1で等倍、2で横を広く見る（256相当） |
| `PQ128_SAMPLE_STRIDE_Y` | 2 | Y方向のサンプリング間隔 | 1で等倍、2で縦を広く見る（256相当） |
| `PQ128_SRC_W` | `PQ128_SIZE*strideX` | 元画像上で参照する実効ROI幅 | `FRAME_WIDTH` を超えると左右がゼロ埋めされる |
| `PQ128_SRC_H` | `PQ128_SIZE*strideY` | 元画像上で参照する実効ROI高さ | `FRAME_HEIGHT` を超えると上下がゼロ埋めされる |
| `PQ128_X0` | `(FRAME_WIDTH - PQ128_SRC_W)/2` | 実効ROIの左上X | 中央基準（負になる場合はゼロ埋め経由で扱う） |
| `PQ128_Y0` | `(FRAME_HEIGHT - PQ128_SRC_H)/2` | 実効ROIの左上Y | 同上 |
| `PQ128_BORDER_ZERO_N` | 0 | 端Nピクセルを強制0（FFT境界対策） | 境界が荒れる時は 1〜4 から試す |
| `PQ128_APPLY_STRIDE_COMPENSATION` | 1 | strideで間隔が広がる分を勾配スケール補正 | 基本 1 推奨（見た目のゲインが合う） |

---

## 3. p/q（勾配）生成モード

| マクロ | デフォルト | 意味 | 備考 |
|---|---:|---|---|
| `PQ128_PQ_MODE` | 2 | p/qの生成方式 | 0/1/2=差分系、3=光源モデル系 |
| `PQ128_FLIP_P` | 0 | pの符号反転 | 方向や座標系が逆っぽい時の切り分け用 |
| `PQ128_FLIP_Q` | 0 | qの符号反転 | 同上 |

### `PQ128_PQ_MODE` の概要

- `0`: 正規化（den で割る）
- `1`: 非正規化（差分に定数スケールを掛ける）
- `2`: pow2 近似（割り算を近似して高速/安定寄り）
- `3`: 光源モデル（light vector 由来の比率で p/q を作る）

差分系（0/1/2）は「見た目の輝度変化」を形状として解釈しやすいので、マルチカラー物体では後述のマスク系を併用する前提。

### 追加スケール/定数

| マクロ | デフォルト | 意味 |
|---|---:|---|
| `PQ128_NORM_EPS` | 16 | 正規化の分母に足すε（ゼロ割/過大ゲイン抑制） |
| `PQ128_NORM_SCALE` | 256 | 正規化時のスケール |
| `PQ128_DIFF_SCALE` | 1 | `PQ_MODE==1`（非正規化）時の差分スケール |
| `PQ128_USE_RECIP_LUT` | 1 | `PQ_MODE==0` の割り算をLUT化 |
| `PQ128_DEN_MAX` | `510 + PQ128_NORM_EPS` | reciprocal LUTの上限（実装都合） |
| `PQ128_LIGHTMODEL_SCALE` | 2048 | `PQ_MODE==3` の p/q スケール（int16格納前） |

---

## 4. 輝度側の前処理（飽和/黒つぶれ/ニー）

### 4.1 飽和（白飛び）ソフトマスク

| マクロ | デフォルト | 意味 | 調整の目安 |
|---|---:|---|---|
| `PQ128_SAT_TH` | 245 | これ以上は重み0（完全無効） | 白飛びが多いなら下げる（例: 230） |
| `PQ128_USE_SAT_SOFTMASK` | 1 | 飽和域に向けて滑らかに重みを落とす | 1推奨 |
| `PQ128_SAT_SOFT_START` | 200 | ここから徐々に落とし始める | 低めにすると白付近を強く抑制 |
| `PQ128_SAT_SOFT_POWER2` | 1 | 重み曲線を二乗（より強く落とす） | 強すぎるなら 0 |

### 4.2 暗部（低SNR）ソフトマスク（濃い青/濃い赤対策）

| マクロ | デフォルト | 意味 | 調整の目安 |
|---|---:|---|---|
| `PQ128_USE_DARK_SOFTMASK` | 0 | 暗部では勾配を信じない（重み低下） | 濃色が崩れる時に 1 |
| `PQ128_DARK_TH` | 8 | ここ以下は重み0 | 0〜16 目安 |
| `PQ128_DARK_SOFT_END` | 40 | ここ以上は重み1 | 30〜80 目安 |
| `PQ128_DARK_SOFT_POWER2` | 1 | 曲線を二乗（暗部をより強く抑制） | 強すぎるなら 0 |

濃い青/濃い赤は「Yが低くなりやすい」→差分ノイズ比が悪化→p/qが暴れやすい、という前提の抑制策。

### 4.3 強度ニー（ハイライト圧縮）

| マクロ | デフォルト | 意味 | 調整の目安 |
|---|---:|---|---|
| `PQ128_USE_INTENSITY_KNEE` | 1 | YをLUTで圧縮（ハイライト抑制） | 眩しい/飽和しがちなら 1 |
| `PQ128_KNEE_START` | 210 | ここから先を圧縮 | 180〜230 |
| `PQ128_KNEE_SHIFT` | 8 | 圧縮の強さ（右シフト量） | 大きいほど強く潰す |

---

## 5. マルチカラー対策（色境界＝形状と誤認しない）

### クロマ（U/V）のエッジで p/q を抑制

| マクロ | デフォルト | 意味 | 調整の目安 |
|---|---:|---|---|
| `PQ128_USE_CHROMA_EDGEMASK` | 1 | クロマ境界（色の変化）が強い場所で重み低下 | 色境界の偽形状が出るなら 1 |
| `PQ128_CHROMA_EDGE_START` | 16 | ここ以下は抑制しない（重み1） | 抑制が強すぎるなら上げる |
| `PQ128_CHROMA_EDGE_TH` | 48 | ここ以上は重み0 | 偽形状が残るなら下げる |
| `PQ128_CHROMA_EDGE_POWER2` | 1 | 曲線を二乗（抑制を強く） | 強すぎるなら 0 |

注意: クロマエッジは「色差の境界」を落とすのに効きますが、色が濃い領域そのものが暗い場合は、暗部マスクの方が効きやすいです。

---

## 6. FFT境界対策（テーパ）

| マクロ | デフォルト | 意味 | 調整の目安 |
|---|---:|---|---|
| `PQ128_USE_TAPER` | 1 | 端に向けて重みを落とす（Raised-cosine） | 1推奨 |
| `PQ128_TAPER_WIDTH` | 16 | テーパ幅 | 境界が荒いなら増やす（例: 24） |

`PQ128_BORDER_ZERO_N`（完全0）と `TAPER`（滑らかに0へ）を併用すると、FFT由来の境界アーティファクトが減りやすいです。

---

## 7. 深度（Z）→ 8bit 出力の正規化/見え方

### 7.0 FFTサイズ（ゼロパディング）

| マクロ | デフォルト | 意味 | 備考 |
|---|---:|---|---|
| `FC_FFT_N` | 128 | FC積分で使うFFTグリッドサイズ | 256にすると「128を外周ゼロパディング→256 FFT→中心128だけ出力」 |
| `FC_RESULT_N` | 128 | 最終的に出力する深度サイズ | 現状は固定（128のまま） |

| マクロ | デフォルト | 意味 | 調整の目安 |
|---|---:|---|---|
| `FC128_EXPORT_USE_ZMINMAX_EMA` | 0 | min/max をEMAで平滑（フリッカ対策） | フリッカが気になる時に 1 |
| `FC128_EXPORT_ZMINMAX_EMA_SHIFT` | 3 | EMAの強さ（$k=1/2^{shift}$） | 大きいほど追従が遅い |
| `FC128_EXPORT_RANGE_FLOOR` | 1.0e-6 | レンジ下限（ゼロ割/過大ゲイン防止） | 基本固定 |
| `FC128_EXPORT_CONTRAST_Q15` | `32768/3*2` | 出力コントラスト（Q15） | 32768=1.0、上げると強調 |
| `FC128_EXPORT_INVERT` | 0 | 出力を `255-out` で反転（手前/奥の反転） | 全体が逆の時だけ 1 |

補足: 128×128 の深度は 320×240 の中央に配置されます（stride設定とは独立）。

---

## 8. 症状別の“まず触る所”

- 色境界が形状に見える: `PQ128_USE_CHROMA_EDGEMASK=1` を維持しつつ、抑制が強すぎるなら `PQ128_CHROMA_EDGE_START` を上げる / `PQ128_CHROMA_EDGE_TH` を上げる。
- 濃い青/濃い赤だけ変: `PQ128_USE_DARK_SOFTMASK=1` を試し、必要なら `PQ128_DARK_SOFT_END` を上げる（暗部でも少し勾配を使う）。
- 境界が荒れる/リング: `PQ128_BORDER_ZERO_N` を 1〜4、`PQ128_TAPER_WIDTH` を増やす。
- 手前/奥が全体的に逆: `FC128_EXPORT_INVERT=1`（もしくは `PQ128_FLIP_P/Q` で切り分け）。

---

## 9. 変更履歴（このメモの目的）

このファイルは「どのマクロが何に効くか」を残すためのメモです。値を変えたら、ここにも追記していく運用を想定しています。
